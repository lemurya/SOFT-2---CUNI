import React, { useEffect, useState } from 'react';
import {
  Box, Typography, Button, Stack, Grid, Card, CardContent, Divider
} from '@mui/material';
import {
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
} from 'recharts';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

const Reportes = () => {
  const [usuario, setUsuario] = useState(null);
  const [reportes, setReportes] = useState([]);
  const [temaSeleccionado, setTemaSeleccionado] = useState(null);
  const temas = ['matematica', 'verbal', 'ciencias', 'historia'];

  useEffect(() => {
    const datos = JSON.parse(localStorage.getItem('usuario'));
    setUsuario(datos);
  }, []);

  useEffect(() => {
    if (usuario?.id) {
      fetch(`http://localhost:3000/api/reportes/${usuario.id}`)
        .then(res => res.json())
        .then(data => setReportes(data.reportes || []))
        .catch(err => console.error('Error al cargar reportes:', err));
    }
  }, [usuario]);

  const reportesFiltrados = temaSeleccionado
    ? reportes.filter(r => r.tema.toLowerCase() === temaSeleccionado)
    : reportes;

  const totalSimulacros = reportes.length;
  const totalCorrectas = reportes.reduce((sum, r) => sum + r.correctas, 0);
  const totalPreguntas = reportes.reduce((sum, r) => sum + r.total, 0);
  const porcentajeGlobal = totalPreguntas > 0
    ? ((totalCorrectas / totalPreguntas) * 100).toFixed(1)
    : 0;
  const ultimaFecha = reportes.length > 0
    ? new Date(Math.max(...reportes.map(r => new Date(r.fecha)))).toLocaleString()
    : '---';

  const estadisticasPorTema = temas.map(tema => {
    const reportesTema = reportes.filter(r => r.tema === tema);
    const totalC = reportesTema.reduce((sum, r) => sum + r.correctas, 0);
    const totalT = reportesTema.reduce((sum, r) => sum + r.total, 0);
    return {
      tema,
      intentos: reportesTema.length,
      promedio: reportesTema.length > 0 ? (totalC / reportesTema.length).toFixed(2) : 0,
      porcentaje: totalT > 0 ? ((totalC / totalT) * 100).toFixed(1) : 0,
    };
  });

  const datosGrafico = [...reportesFiltrados]
    .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
    .map((r, index) => ({
      examen: `Intento ${index + 1}`,
      aciertos: r.correctas,
    }));

  const generarPDF = () => {
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text('Reporte de Simulacros', 14, 20);

    doc.setFontSize(12);
    doc.text(`Usuario: ${usuario?.nombre || 'N/A'}`, 14, 30);
    doc.text(`Total de simulacros: ${totalSimulacros}`, 14, 38);
    doc.text(`Porcentaje global de aciertos: ${porcentajeGlobal}%`, 14, 46);
    doc.text(`Ãšltimo intento: ${ultimaFecha}`, 14, 54);

    autoTable(doc, {
      startY: 64,
      head: [['Tema', 'Intentos', 'Promedio Aciertos', 'Porcentaje']],
      body: estadisticasPorTema.map(e => [
        e.tema.toUpperCase(),
        e.intentos,
        e.promedio,
        `${e.porcentaje}%`
      ])
    });

    autoTable(doc, {
      startY: doc.lastAutoTable.finalY + 10,
      head: [['Tema', 'Correctas', 'Total', 'Fecha', 'Hora']],
      body: reportesFiltrados.map(r => [
        r.tema,
        r.correctas,
        r.total,
        new Date(r.fecha).toLocaleDateString(),
        new Date(r.fecha).toLocaleTimeString()
      ]),
      theme: 'striped',
      styles: { fontSize: 10 },
    });

    doc.save(`reporte_${usuario?.nombre || 'usuario'}.pdf`);
  };

  return (
    <Box sx={{ minHeight: '100vh', bgcolor: '#F9F6FF', px: 6, py: 8 }}>
      <Typography variant="h4" align="center" gutterBottom fontWeight="bold">
        Historial de Reportes
      </Typography>

      <Card sx={{ mb: 4 }} elevation={2}>
        <CardContent>
          <Typography variant="h6" gutterBottom>Resumen General</Typography>
          <Typography variant="body2">Total de simulacros: {totalSimulacros}</Typography>
          <Typography variant="body2">Porcentaje global de aciertos: {porcentajeGlobal}%</Typography>
          <Typography variant="body2">Ãšltimo intento: {ultimaFecha}</Typography>
        </CardContent>
      </Card>

      <Grid container spacing={2} sx={{ mb: 4 }}>
        {estadisticasPorTema.map((e, i) => (
          <Grid item xs={12} sm={6} md={3} key={i}>
            <Card elevation={1}>
              <CardContent>
                <Typography variant="subtitle1" fontWeight="bold">
                  {e.tema.toUpperCase()}
                </Typography>
                <Typography variant="body2">Intentos: {e.intentos}</Typography>
                <Typography variant="body2">Promedio aciertos: {e.promedio}</Typography>
                <Typography variant="body2">Porcentaje: {e.porcentaje}%</Typography>
              </CardContent>
            </Card>
          </Grid>
        ))}
      </Grid>

      <Card sx={{ mb: 4 }} elevation={2}>
        <CardContent>
          <Typography variant="h6" gutterBottom>
            EvoluciÃ³n de aciertos {temaSeleccionado ? `(${temaSeleccionado})` : ''}
          </Typography>
          {datosGrafico.length === 0 ? (
            <Typography variant="body2" color="text.secondary">
              No hay datos para mostrar en el grÃ¡fico.
            </Typography>
          ) : (
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={datosGrafico}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="examen" />
                <YAxis allowDecimals={false} />
                <Tooltip />
                <Line type="monotone" dataKey="aciertos" stroke="#1976d2" />
              </LineChart>
            </ResponsiveContainer>
          )}
        </CardContent>
      </Card>

      <Stack spacing={2} direction="row" justifyContent="center" flexWrap="wrap" sx={{ mb: 2 }}>
        <Button
          variant={temaSeleccionado === null ? "contained" : "outlined"}
          onClick={() => setTemaSeleccionado(null)}
        >
          TODOS
        </Button>
        {temas.map((tema) => (
          <Button
            key={tema}
            variant={temaSeleccionado === tema ? "contained" : "outlined"}
            onClick={() => setTemaSeleccionado(tema)}
          >
            REPORTE DE {tema.toUpperCase()}
          </Button>
        ))}
        <Button variant="outlined" color="secondary" onClick={generarPDF}>
          Descargar PDF
        </Button>
      </Stack>

      <Typography variant="h6" gutterBottom>
        ðŸ“‹ Historial de ExÃ¡menes {temaSeleccionado ? `(${temaSeleccionado})` : ''}
      </Typography>

      {reportesFiltrados.length === 0 ? (
        <Typography align="center" color="text.secondary">
          No hay reportes para este tema.
        </Typography>
      ) : (
        <Grid container spacing={3} justifyContent="center">
          {reportesFiltrados.map((r, index) => (
            <Grid item xs={12} sm={6} md={4} key={index}>
              <Card elevation={3}>
                <CardContent>
                  <Typography variant="subtitle1" fontWeight="bold">
                    Tema: {r.tema.charAt(0).toUpperCase() + r.tema.slice(1)}
                  </Typography>
                  <Typography variant="body2">
                    Resultado: {r.correctas} correctas de {r.total}
                  </Typography>
                  <Typography variant="body2">
                    Fecha: {new Date(r.fecha).toLocaleDateString()}
                  </Typography>
                  <Typography variant="body2">
                    Hora: {new Date(r.fecha).toLocaleTimeString()}
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          ))}
        </Grid>
      )}
    </Box>
  );
};

export default Reportes;
